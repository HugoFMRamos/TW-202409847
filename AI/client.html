<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Simple WebRTC Video Chat</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 12px; }
    video { width: 320px; height: 240px; background: #000; }
    #controls { margin-bottom: 12px; }
  </style>
</head>
<body>
  <h2>Simple WebRTC video chat</h2>
  <div id="controls">
    <input id="roomInput" placeholder="room id (e.g. room1)" />
    <button id="joinBtn">Join</button>
    <button id="leaveBtn" disabled>Leave</button>
  </div>

  <div>
    <div>
      <strong>Local</strong><br />
      <video id="localVideo" autoplay muted playsinline></video>
    </div>
    <div>
      <strong>Remote</strong><br />
      <video id="remoteVideo" autoplay playsinline></video>
    </div>
  </div>

<script>
(async function() {
  const localVideo = document.getElementById('localVideo');
  const remoteVideo = document.getElementById('remoteVideo');
  const joinBtn = document.getElementById('joinBtn');
  const leaveBtn = document.getElementById('leaveBtn');
  const roomInput = document.getElementById('roomInput');

  let localStream = null;
  let pc = null;
  let ws = null;
  let roomId = null;

  // STUN server for NAT traversal
  const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

  async function startLocalStream() {
    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    localVideo.srcObject = localStream;
  }

  function createPeerConnection() {
    pc = new RTCPeerConnection(rtcConfig);

    // send any ICE candidate to the remote peer via signaling
    pc.onicecandidate = (event) => {
      if (event.candidate) {
        ws.send(JSON.stringify({ type: 'candidate', room: roomId, payload: event.candidate }));
      }
    };

    // when remote track arrives, show it
    pc.ontrack = (evt) => {
      // If multiple tracks, attach the first stream
      remoteVideo.srcObject = evt.streams[0];
    };

    // add local tracks to the connection
    if (localStream) {
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
    }

    return pc;
  }

  function setupWebSocket() {
    ws = new WebSocket('ws://localhost:3000');
    ws.onopen = () => console.log('Connected to signaling server');
    ws.onmessage = async (message) => {
      let data = JSON.parse(message.data);
      const { type, payload } = data;
      console.log('Signaling message', type, payload);

      if (type === 'peer-joined') {
        // someone else joined â€” if we created the room earlier we should create an offer
        // create offer and send it
        if (!pc) createPeerConnection();
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        ws.send(JSON.stringify({ type: 'offer', room: roomId, payload: offer }));
      } else if (type === 'offer') {
        if (!pc) createPeerConnection();
        await pc.setRemoteDescription(new RTCSessionDescription(payload));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        ws.send(JSON.stringify({ type: 'answer', room: roomId, payload: answer }));
      } else if (type === 'answer') {
        await pc.setRemoteDescription(new RTCSessionDescription(payload));
      } else if (type === 'candidate') {
        try {
          await pc.addIceCandidate(new RTCIceCandidate(payload));
        } catch (e) {
          console.error('Error adding received ICE candidate', e);
        }
      }
    };

    ws.onclose = () => console.log('Signaling connection closed');
    ws.onerror = (err) => console.error('Signaling error', err);
  }

  joinBtn.addEventListener('click', async () => {
    roomId = roomInput.value.trim();
    if (!roomId) { alert('Enter a room id'); return; }

    joinBtn.disabled = true;
    leaveBtn.disabled = false;

    await startLocalStream();
    setupWebSocket();

    // join room
    ws.addEventListener('open', () => {
      ws.send(JSON.stringify({ type: 'join', room: roomId }));
    });

    // If you want to be the one initiating immediately (e.g. if you're the 2nd peer),
    // the server will send 'peer-joined' to existing peers when someone joins.
  });

  leaveBtn.addEventListener('click', () => {
    if (pc) {
      pc.close();
      pc = null;
    }
    if (ws) {
      ws.close();
      ws = null;
    }
    if (localStream) {
      localStream.getTracks().forEach(t => t.stop());
      localStream = null;
      localVideo.srcObject = null;
    }
    remoteVideo.srcObject = null;

    joinBtn.disabled = false;
    leaveBtn.disabled = true;
  });

})();
</script>
</body>
</html>